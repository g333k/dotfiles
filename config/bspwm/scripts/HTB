#!/bin/bash
# ===============================================
#        Improved Interactive VPN Manager
# ===============================================

SRC_DIR="$HOME/.config/bspwm/scripts/src"
LOGFILE="$HOME/.htb-vpn.log"

# ANSI Colors
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
CYAN="\e[36m"
BOLD="\e[1m"
RESET="\e[0m"

ICON_VPN_ON="üîê"
ICON_VPN_OFF="üì¥"

# Simple loading animation
loading() {
    local msg="$1"
    echo -ne "${CYAN}${msg} ${RESET}"
    for c in '/' '-' '\' '|'; do
        echo -ne "\b$c"
        sleep 0.2
    done
    echo -e "\b "
}

# Detect if VPN is active
vpn_status() {
    if ip a | grep -q tun0; then
        return 0   # connected
    else
        return 1   # disconnected
    fi
}

# Display status with colors
print_status() {
    if vpn_status; then
        echo -e "${GREEN}[‚úî] VPN Connected${RESET}"
    else
        echo -e "${YELLOW}[‚úñ] VPN Disconnected${RESET}"
    fi
}

# Status notification
notify_vpn() {
    local status="$1"
    if [ "$status" -eq 0 ]; then
        notify-send -u normal "VPN Connected" "VPN connection established successfully üîê"
    else
        notify-send -u critical "VPN Disconnected" "VPN disconnected or failed to connect üì¥"
    fi
}

# Show VPN files menu
choose_vpn() {
    cd "$SRC_DIR" || exit 1
    OVPN_FILES=(*.ovpn)
    if [ ${#OVPN_FILES[@]} -eq 0 ]; then
        echo -e "${RED}‚ùå No .ovpn files found${RESET}"
        exit 1
    fi

    echo -e "${CYAN}==============================================${RESET}"
    echo -e "${BOLD} Available VPN Files:${RESET}"
    echo -e "${CYAN}==============================================${RESET}"
    for i in "${!OVPN_FILES[@]}"; do
        printf "${GREEN}[%d]${RESET} %s\n" $((i+1)) "${OVPN_FILES[$i]}"
    done
    echo -e "${CYAN}==============================================${RESET}"

    while true; do
        read -rp "Select a VPN by number: " choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#OVPN_FILES[@]}" ]; then
            VPN_CONFIG="$SRC_DIR/${OVPN_FILES[$((choice-1))]}"
            echo -e "${GREEN}[‚úî] You selected: ${OVPN_FILES[$((choice-1))]}${RESET}"
            break
        else
            echo -e "${RED}Invalid option, please try again.${RESET}"
        fi
    done
}

# Connect VPN
connect_vpn() {
    loading "Connecting VPN..."
    sudo openvpn --config "$VPN_CONFIG" --daemon --log "$LOGFILE"
    sleep 5
    vpn_status
    notify_vpn $?
    print_status
}

# Disconnect VPN
disconnect_vpn() {
    loading "Disconnecting VPN..."
    sudo pkill openvpn
    sleep 3
    vpn_status
    notify_vpn $?
    print_status
}

# --- MAIN ---
echo -e "Current status:"
print_status

if vpn_status; then
    # Already connected ‚Üí offer to disconnect
    read -rp "Do you want to disconnect the VPN? (y/n): " ans
    if [[ "$ans" =~ ^[yY]$ ]]; then
        disconnect_vpn
    else
        echo -e "${YELLOW}Operation cancelled.${RESET}"
    fi
else
    # Not connected ‚Üí choose file and connect
    choose_vpn
    connect_vpn
fi


