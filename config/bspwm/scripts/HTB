#!/bin/bash
# ===============================================
#        VPN Manager Interactivo Mejorado
# ===============================================

SRC_DIR="$HOME/.config/bspwm/scripts/src"
LOGFILE="$HOME/.htb-vpn.log"

# Colores ANSI
RED="\e[31m"
GREEN="\e[32m"
YELLOW="\e[33m"
CYAN="\e[36m"
BOLD="\e[1m"
RESET="\e[0m"

ICON_VPN_ON="üîê"
ICON_VPN_OFF="üì¥"

# Animaci√≥n de carga simple
loading() {
    local msg="$1"
    echo -ne "${CYAN}${msg} ${RESET}"
    for c in '/' '-' '\' '|'; do
        echo -ne "\b$c"
        sleep 0.2
    done
    echo -e "\b "
}

# Detectar si VPN est√° activa
vpn_status() {
    if ip a | grep -q tun0; then
        echo -e "${GREEN}[‚úî] VPN Conectada${RESET}"
        return 0
    else
        echo -e "${YELLOW}[‚úñ] VPN Desconectada${RESET}"
        return 1
    fi
}

# Mostrar men√∫
choose_vpn() {
    cd "$SRC_DIR" || exit 1
    OVPN_FILES=(*.ovpn)
    if [ ${#OVPN_FILES[@]} -eq 0 ]; then
        echo -e "${RED}‚ùå No se encontraron archivos .ovpn${RESET}"
        exit 1
    fi

    echo -e "${CYAN}==============================================${RESET}"
    echo -e "${BOLD} Archivos VPN disponibles:${RESET}"
    echo -e "${CYAN}==============================================${RESET}"
    for i in "${!OVPN_FILES[@]}"; do
        printf "${GREEN}[%d]${RESET} %s\n" $((i+1)) "${OVPN_FILES[$i]}"
    done
    echo -e "${CYAN}==============================================${RESET}"

    while true; do
        read -rp "Selecciona una VPN por n√∫mero: " choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && [ "$choice" -ge 1 ] && [ "$choice" -le "${#OVPN_FILES[@]}" ]; then
            VPN_CONFIG="$SRC_DIR/${OVPN_FILES[$((choice-1))]}"
            echo -e "${GREEN}[‚úî] Seleccionaste: ${OVPN_FILES[$((choice-1))]}${RESET}"
            break
        else
            echo -e "${RED}Opci√≥n inv√°lida, intenta nuevamente.${RESET}"
        fi
    done
}

# Conectar VPN
connect_vpn() {
    loading "Conectando VPN..."
    sudo openvpn --config "$VPN_CONFIG" --daemon --log "$LOGFILE"
    sleep 3
    vpn_status
}

# Desconectar VPN
disconnect_vpn() {
    loading "Desconectando VPN..."
    sudo pkill openvpn
    sleep 2
    vpn_status
}

# --- MAIN ---
echo -e "Estado actual: $(vpn_status)"

choose_vpn

if ip a | grep -q tun0; then
    disconnect_vpn
else
    connect_vpn
fi

